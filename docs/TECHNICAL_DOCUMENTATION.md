# Техническая документация: Аналитика УИ ОГПЗ

Этот документ содержит подробное описание архитектуры, алгоритмов и программного кода приложения "Аналитика УИ ОГПЗ".

---

## 1. Структура проекта

Проект организован как Python-пакет с вспомогательными скриптами для сборки и установки.

```text
Soft_Analiz_UI_OGPZ_ONGKM/
├── analytics_ui/               # Основной пакет приложения
│   ├── __init__.py             # Инициализация пакета
│   ├── excel_merger.py         # Главный модуль с GUI и логикой
│   ├── post_install.py         # Скрипт создания ярлыков
│   ├── icon.png                # Иконка приложения
│   └── Правила названия столбцов.xlsx # Конфигурационный файл
├── scripts/                    # Скрипты для DevOps
│   ├── build_wheel.sh          # Сборка .whl (Linux)
│   ├── build_wheel.bat         # Сборка .whl (Windows)
│   ├── install_redos.sh        # Установка на RedOS
│   └── uninstall_redos.sh      # Удаление с RedOS
├── logs/                       # Логи сборки
├── legacy/                     # Устаревшие файлы (архив)
├── dist/                       # Скомпилированные пакеты (.whl)
├── docs/                       # Документация проекта
│   ├── CODEWIKI.md             # Основная вики
│   ├── DOCUMENTATION.md        # Руководство пользователя
│   └── ...                     # Другие документы
├── setup.py                    # Конфигурация установки пакета
├── MANIFEST.in                 # Список файлов для включения в пакет
└── ...
```

---

## 2. Алгоритмы работы

### 2.1. Алгоритм объединения файлов (`merge_files`)
1.  **Валидация**: Проверяется, выбраны ли файлы, параметры и узлы измерения.
2.  **Чтение правил**: Загружается файл `Правила названия столбцов.xlsx`. Строятся словари соответствия:
    *   `param_to_columns`: Параметр -> Набор допустимых имен столбцов.
    *   `node_to_columns`: Узел -> Набор допустимых имен столбцов.
3.  **Фильтрация столбцов**: Вычисляется пересечение множеств столбцов, разрешенных выбранными параметрами и выбранными узлами.
4.  **Обработка файлов**:
    *   Файлы читаются по очереди.
    *   Для каждого файла применяются правила переименования столбцов (функция `get_rename_rules`).
    *   Удаляются столбцы, не входящие в список разрешенных.
    *   Из первого файла сохраняется столбец "Время", из остальных он удаляется.
5.  **Слияние**: Все обработанные DataFrame объединяются горизонтально (`pd.concat(axis=1)`).
6.  **Фильтрация по времени**: Если задан интервал, данные обрезаются по столбцу "Время".

### 2.2. Алгоритм условного форматирования (`apply_conditional_formatting`)
Использует библиотеку `openpyxl` для прямой модификации Excel-файла.
1.  **Цветовая шкала**: Применяется `ColorScaleRule` (Красный → Желтый → Зеленый) к ячейкам с данными. Нулевые значения игнорируются.
2.  **Группировка границ**:
    *   Столбцы группируются по "Узлам измерения".
    *   Между группами узлов рисуется толстая граница (`thick_border`).
    *   Внутри группы границы обычные.
3.  **Стрелки трендов**:
    *   Функция `add_arrow_columns` проверяет значения на выход за пределы min/max (из файла правил).
    *   Если значение < min, ставится стрелка `↓`.
    *   Если значение > max, ставится стрелка `↑`.
    *   Столбец со стрелками вставляется справа от значения.

---

## 3. Описание функций

### Модуль `analytics_ui.excel_merger`

#### Вспомогательные функции

*   **`resource_path(relative_path)`**
    *   **Описание**: Возвращает абсолютный путь к ресурсу (файлу правил, иконке).
    *   **Логика**: Умеет работать в трех режимах:
        1.  Запуск из исходников (ищет относительно файла).
        2.  Запуск как PyInstaller exe (ищет в `sys._MEIPASS`).
        3.  Запуск как установленный пакет (ищет в `site-packages`).

*   **`get_column_letter(col_idx)`**
    *   **Описание**: Конвертирует индекс столбца (1, 2, 3) в букву Excel (A, B, C).

*   **`setup_logging()`**
    *   **Описание**: Настраивает логирование в файл `~/.analytics_ui/app.log`.

#### Логика обработки данных

*   **`apply_conditional_formatting(file_path)`**
    *   **Аргументы**: `file_path` (str) - путь к сохраненному Excel файлу.
    *   **Описание**: Открывает файл, применяет стили, границы и цветовую шкалу. Сохраняет изменения во временный файл, затем заменяет оригинал.

*   **`add_arrow_columns(df, rules_file)`**
    *   **Аргументы**: `df` (DataFrame), `rules_file` (str).
    *   **Описание**: Добавляет столбцы с индикаторами (стрелками) на основе лимитов min/max из файла правил.

#### Класс `ExcelMerger` (GUI)

*   **`__init__(self, root)`**: Инициализация главного окна, списков и переменных.
*   **`create_widgets(self)`**: Создание всех элементов интерфейса (кнопки, списки, чекбоксы).
*   **`load_parameters(self)`**: Читает уникальные параметры из файла правил и создает для них чекбоксы.
*   **`update_measurement_nodes(self)`**: Сканирует загруженные файлы, находит соответствующие им узлы измерения в правилах и обновляет список чекбоксов узлов.
*   **`read_excel_file(self, file_path)`**: Обертка над `pd.read_excel` с поддержкой `.xls` (через `xlrd`) и `.xlsx` (через `openpyxl`).
*   **`get_rename_rules(self, filename)`**: Возвращает словарь `{старое_имя: новое_имя}` для конкретного файла на основе правил.
*   **`merge_files(self)`**: Основная функция-оркестратор. Собирает данные, фильтрует, объединяет и сохраняет результат.

### Модуль `analytics_ui.post_install`

*   **`create_shortcuts()`**
    *   **Описание**: Создает `.desktop` файлы для интеграции с окружением рабочего стола Linux.
    *   **Логика**:
        1.  Находит путь к исполняемому файлу `analytics-ui`.
        2.  Находит путь к иконке внутри пакета.
        3.  Генерирует содержимое `.desktop` файла.
        4.  Записывает файл в `~/.local/share/applications/` (меню) и `~/Desktop/` (рабочий стол).
        5.  Устанавливает права на исполнение (`chmod +x`).

---

## 4. Конфигурационные файлы

### `setup.py`
Скрипт сборки пакета `setuptools`.
*   **`entry_points`**:
    *   `analytics-ui`: Запускает `excel_merger:main`.
    *   `analytics-ui-setup`: Запускает `post_install:create_shortcuts`.
*   **`package_data`**: Включает `*.xlsx` и `*.png` в сборку.

### `MANIFEST.in`
Указывает дополнительные файлы, которые нужно включить в исходный дистрибутив (sdist), чтобы они попали в wheel.
